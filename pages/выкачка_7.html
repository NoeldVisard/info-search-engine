<!DOCTYPE html>

<html data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D" lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1,user-scalable=0" name="viewport"/>
<meta content="unsafe-url" name="referrer"/>
<title>Облако для тех, кому нельзя в облака: как мы в ОТП Банке развернули закрытое облако на платформе Яндекса / Хабр</title>







<meta content="2.165.0" name="habr-version"/>
<meta content="444736788986613" data-vue-meta="ssr" property="fb:app_id"/><meta content="472597926099084" data-vue-meta="ssr" property="fb:pages"/><meta content="summary_large_image" data-vue-meta="ssr" name="twitter:card"/><meta content="@habr_com" data-vue-meta="ssr" name="twitter:site"/><meta content="Хабр" data-vmid="og:site_name" data-vue-meta="ssr" property="og:site_name"/><meta content="Облако для тех, кому нельзя в облака: как мы в ОТП Банке развернули закрытое облако на платформе Яндекса" data-vmid="og:title" data-vue-meta="ssr" property="og:title"/><meta content="Облако для тех, кому нельзя в облака: как мы в ОТП Банке развернули закрытое облако на платформе Яндекса" data-vmid="twitter:title" data-vue-meta="ssr" name="twitter:title"/><meta content="Облако для тех, кому нельзя в облака: как мы в ОТП Банке развернули закрытое облако на платформе Яндекса" data-vmid="aiturec:title" data-vue-meta="ssr" name="aiturec:title"/><meta content="Серьёзно, банк на облачной платформе? Те читатели, кто занимается инфобезом в финтехе, сейчас, наверное, или смеются, или в ужасе думают о последствиях такого решения. И тем не менее мы в ОТП Банке..." data-vmid="description" data-vue-meta="ssr" name="description"/><meta content="Серьёзно, банк на облачной платформе? Те читатели, кто занимается инфобезом в финтехе, сейчас, наверное, или смеются, или в ужасе думают о последствиях такого решения. И тем не менее мы в ОТП Банке..." data-vmid="description:itemprop" data-vue-meta="ssr" itemprop="description"/><meta content="Серьёзно, банк на облачной платформе? Те читатели, кто занимается инфобезом в финтехе, сейчас, наверное, или смеются, или в ужасе думают о последствиях такого решения. И тем не менее мы в ОТП Банке..." data-vmid="og:description" data-vue-meta="ssr" property="og:description"/><meta content="Серьёзно, банк на облачной платформе? Те читатели, кто занимается инфобезом в финтехе, сейчас, наверное, или смеются, или в ужасе думают о последствиях такого решения. И тем не менее мы в ОТП Банке..." data-vmid="twitter:description" data-vue-meta="ssr" name="twitter:description"/><meta content="Серьёзно, банк на облачной платформе? Те читатели, кто занимается инфобезом в финтехе, сейчас, наверное, или смеются, или в ужасе думают о последствиях такого решения. И тем не менее мы в ОТП Банке..." data-vmid="aiturec:description" data-vue-meta="ssr" property="aiturec:description"/><meta content="https://habrastorage.org/getpro/habr/upload_files/32a/e28/e39/32ae28e39c42aed1ad9b5765d90cba30.png" data-vmid="image:itemprop" data-vue-meta="ssr" itemprop="image"/><meta content="https://habrastorage.org/getpro/habr/upload_files/32a/e28/e39/32ae28e39c42aed1ad9b5765d90cba30.png" data-vmid="og:image" data-vue-meta="ssr" property="og:image"/><meta content="1200" data-vmid="og:image:width" data-vue-meta="ssr" property="og:image:width"/><meta content="630" data-vmid="og:image:height" data-vue-meta="ssr" property="og:image:height"/><meta content="https://habrastorage.org/getpro/habr/upload_files/32a/e28/e39/32ae28e39c42aed1ad9b5765d90cba30.png" data-vmid="aiturec:image" data-vue-meta="ssr" property="aiturec:image"/><meta content="https://habrastorage.org/getpro/habr/upload_files/32a/e28/e39/32ae28e39c42aed1ad9b5765d90cba30.png" data-vmid="twitter:image" data-vue-meta="ssr" name="twitter:image"/><meta content="https://habrastorage.org/getpro/habr/upload_files/32a/e28/e39/32ae28e39c42aed1ad9b5765d90cba30.png?format=vk" data-vmid="vk:image" data-vue-meta="ssr" property="vk:image"/><meta content="793746" data-vmid="aiturec:item_id" data-vue-meta="ssr" property="aiturec:item_id"/><meta content="2024-02-15T09:00:37.000Z" data-vmid="aiturec:datetime" data-vue-meta="ssr" property="aiturec:datetime"/><meta content="https://habr.com/ru/companies/otpbank/articles/793746/" data-vmid="og:url" data-vue-meta="ssr" property="og:url"/><meta content="article" data-vmid="og:type" data-vue-meta="ssr" property="og:type"/><meta content="ru_RU" data-vmid="og:locale" data-vue-meta="ssr" property="og:locale"/><meta content="частное облако, облако, яндекс, yandex cloud, ad, coredns, terraform, pulumi, ansible, garbage collection" data-vue-meta="ssr" name="keywords"/>

<meta content="#303b44" name="apple-mobile-web-app-status-bar-style"/>
<meta content="#629FBC" name="msapplication-TileColor"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="yes" name="mobile-web-app-capable"/>
































</head>
<body>
<div data-async-called="true" data-server-rendered="true" id="app"><div class="tm-layout__wrapper"><!-- --> <div></div> <!-- --> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!-- --> <span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo tm-header__logo_hl-ru" href="/ru/"><svg class="tm-svg-img tm-header__icon" height="16" width="16"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg class="tm-svg-img tm-header__icon tm-header__icon_dropdown" height="16" width="16"><title>Открыть список</title> <use xlink:href="/img/megazord-v28.faec9762..svg#arrow-down"></use></svg></button></div> <!-- --></div> <a class="tm-header__become-author-btn" href="/ru/sandbox/start/">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature tm-feature_variant-inline"><!-- --></div> <!-- --> <!-- --></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div class="tm-base-layout__header tm-base-layout__header_is-sticky" data-menu-sticky="true"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><a class="tm-main-menu__item" href="/ru/feed/">
        Моя лента
      </a> <a class="tm-main-menu__item" href="/ru/articles/">
        Все потоки
      </a> <a class="tm-main-menu__item" href="/ru/flows/develop/">
          Разработка
        </a><a class="tm-main-menu__item" href="/ru/flows/admin/">
          Администрирование
        </a><a class="tm-main-menu__item" href="/ru/flows/design/">
          Дизайн
        </a><a class="tm-main-menu__item" href="/ru/flows/management/">
          Менеджмент
        </a><a class="tm-main-menu__item" href="/ru/flows/marketing/">
          Маркетинг
        </a><a class="tm-main-menu__item" href="/ru/flows/popsci/">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a class="tm-header-user-menu__item tm-header-user-menu__search" href="/ru/search/"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark" height="24" width="24"><title>Поиск</title> <use xlink:href="/img/megazord-v28.faec9762..svg#search"></use></svg></a> <!-- --> <!-- --> <!-- --> <div class="tm-header-user-menu__item"><button class="tm-header-user-menu__toggle"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_dark" height="24" width="24"><title>Настройки</title> <use xlink:href="/img/megazord-v28.faec9762..svg#page-settings"></use></svg></button></div> <a class="tm-header-user-menu__item" href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/companies/otpbank/articles/793746/&amp;hl=ru" rel="nofollow"><button class="tm-header-user-menu__login btn btn_solid btn_small" type="button">
        Войти
      </button></a> <!-- --> <div class="v-portal" style="display:none;"></div></div></div></div></div> <!-- --> <div class="tm-page-width"></div> <main class="tm-layout__container"><div class="tm-page" companyname="otpbank" data-async-called="true" hl="ru"><div class="tm-page-width"><div class="tm-page__header"><div class="tm-company-card__branding tm-company-article__branding tm-company-card__branding_loading"><div class="tm-company-card__branding-placeholder"><!-- --></div> <a href="https://www.otpbank.ru/"><img class="tm-company-card__branding-image" src="//habrastorage.org/getpro/habr/branding/bb0/7ee/f81/bb07eef81a72662e6deaef64fb73dcd8.png" width="100%"/></a></div></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><!-- --> <div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24"><title>Обновить</title> <use xlink:href="/img/megazord-v28.faec9762..svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><!-- --> <div class="tm-company-profile-card tm-company-article__profile-card"><div class="tm-company-card tm-company-profile-card__info"><div class="tm-company-card__header"><a class="tm-company-card__avatar" href="/ru/companies/otpbank/profile/"><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" height="48" src="//habrastorage.org/getpro/habr/company/3cc/8e8/b55/3cc8e8b551d8126f04c5005009cad0ee.jpg" width="48"/></div></a> <!-- --> <div class="tm-counter-container tm-company-card__rating"><div class="tm-counter-container__header"> <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating"><!-- --> <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-rating"><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_rating">
          42.5
        </span></span></div> <!-- --></div></div> <div class="tm-counter-container__footer"><span class="tm-rating__text tm-rating__text">
      Рейтинг
    </span></div></div> <!-- --></div> <div class="tm-company-card__info"><a class="tm-company-card__name" href="/ru/companies/otpbank/profile/">ОТП Банк</a> <div class="tm-company-card__description">Давай сделаем вместе!</div></div></div> <!-- --></div> <!-- --> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet tm-article-snippet"> <div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a class="tm-user-info__userpic" href="/ru/users/risk_nic/" title="risk_nic"><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" height="24" src="https://assets.habr.com/habr-web/img/avatars/051.png" width="24"/></div></a> <span class="tm-user-info__user tm-user-info__user_appearance-default"><a class="tm-user-info__username" href="/ru/users/risk_nic/">
      risk_nic
      <!-- --></a> <span class="tm-article-datetime-published"><time datetime="2024-02-15T09:00:37.000Z" title="2024-02-15, 12:00">1 час назад</time></span></span></span></div> <!-- --></div> <h1 class="tm-title tm-title_h1" lang="ru"><span>Облако для тех, кому нельзя в облака: как мы в ОТП Банке развернули закрытое облако на платформе Яндекса</span></h1> <div class="tm-article-snippet__stats"><div class="tm-article-complexity tm-article-complexity_complexity-high"><span class="tm-svg-icon__wrapper tm-article-complexity__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Уровень сложности</title> <use xlink:href="/img/megazord-v28.faec9762..svg#complexity-high"></use></svg></span> <span class="tm-article-complexity__label">
    Сложный
  </span></div> <div class="tm-article-reading-time"><span class="tm-svg-icon__wrapper tm-article-reading-time__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Время на прочтение</title> <use xlink:href="/img/megazord-v28.faec9762..svg#clock"></use></svg></span> <span class="tm-article-reading-time__label">
    28 мин
  </span></div> <span class="tm-icon-counter tm-data-icons__item"><svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24"><title>Количество просмотров</title> <use xlink:href="/img/megazord-v28.faec9762..svg#counter-views"></use></svg> <span class="tm-icon-counter__value">344</span></span></div> <div class="tm-publication-hubs__container"><div class="tm-publication-hubs"><span class="tm-publication-hub__link-container"><a class="router-link-active tm-publication-hub__link" href="/ru/companies/otpbank/articles/"><span>Блог компании ОТП Банк</span> <!-- --></a></span><span class="tm-publication-hub__link-container"><a class="tm-publication-hub__link" href="/ru/hubs/infosecurity/"><span>Информационная безопасность</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span><span class="tm-publication-hub__link-container"><a class="tm-publication-hub__link" href="/ru/hubs/cloud_services/"><span>Облачные сервисы</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span><span class="tm-publication-hub__link-container"><a class="tm-publication-hub__link" href="/ru/hubs/kubernetes/"><span>Kubernetes</span> <span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span></a></span></div></div> <!-- --> <!-- --> <!-- --></div></div> <!-- --> <div class="tm-article-body" data-gallery-root="" lang="ru"><div></div> <div id="post-content-body"><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><figure class="full-width"><img data-src="https://habrastorage.org/getpro/habr/upload_files/aba/221/988/aba221988f2cc760d8eea898a5c24b38.png" height="415" src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/aba/221/988/aba221988f2cc760d8eea898a5c24b38.png" width="736"/></figure><p>Серьёзно, банк на облачной платформе? Те читатели, кто занимается инфобезом в финтехе, сейчас, наверное, или смеются, или в ужасе думают о последствиях такого решения.</p><p>И тем не менее мы в ОТП Банке полтора года назад взялись за эту задачу — и сейчас в Yandex Cloud чувствуем себя отлично. Привет, я из трайба IT4IT ОТП Банка. Мы занимались разработкой нашего закрытого облака. Под катом расскажу, зачем нам облако понадобилось, почему собственное решение не устроило и как мы выполнили требования Управления информационной безопасности (УИБ) никого не впускать и не выпускать — не забыв при этом сделать облако мощным инструментом для наших разработчиков.</p><h2>Есть ли жизнь в облаке для финтеха?</h2><p>Вообще-то, ещё до этого проекта частное облако у нас было — внутреннее, на двух ЦОДах. Но в нём даже близко не хватало ЦПУ и памяти для всех желающих там работать.</p><p>Голый, «нулевой» OpenStack, никакой возможности развернуть что-то полезное просто по кнопке, от того же Kubernetes до баз данных. Есть желание — настраивай с нуля ручками, а нет экспертизы — нет и сервисов.</p><p>Кроме того, двух ЦОДов, которые были доступны в частном облаке, не хватало для реализации кластеризованных систем, например, Kubernetes или PostgreSQL. Они вынужденно пользовались вариантами установки active-passive failover (пассивный резерв), то есть два отдельных инстанса в разных ЦОДах в режиме active-passive, либо вынужденно выносили кворумные ноды за пределы частного облака на классическую виртуализацию (у нас vSphere). Многим это было неудобно.</p><p>Так что мы пошли искать счастье на аутсорсе Ops: опции, ресурсы, три зоны доступности — качественный публичный облачный сервис с PaaS и хорошей техподдержкой. После проведения ряда пилотов выбор пал на Yandex Cloud.</p><p>Бизнес одобрил идею: он тоже читал умные книги и понимал, зачем нам облако необходимо. Казалось бы, вот вам зелёный свет, можно закатывать рукава и приступать к внедрению, но пришёл отдел безопасности — и всё сразу резко усложнилось.</p><p>Как финансовая организация, мы работаем с персональными и финансовыми данными пользователей. А значит, мы на коротком поводке у регулятора. Соответственно, первая реакция на слова «публичная платформа» у инфобеза: «Давайте никого не впускать, никого не выпускать и всё за всеми записывать».</p><h2>Изолироваться от интернета? Звучит как ТЗ!   </h2><p>Конкретнее, для закрытого безопасного облака нам было нужно:</p><ol><li><p>Весь входящий, исходящий трафик пропускать через наши файрволы.</p></li><li><p>Аутентифицировать пользователей нашими AD.</p></li><li><p>Изолировать сети облаков от интернета.</p></li><li><p>Вести аудит всех действий в <a href="https://cloud.yandex.ru/docs/organization/">Организации</a> в облаке.</p></li></ol><details class="spoiler"><summary>Hidden text</summary><div class="spoiler__content"><p>Организация с большой буквы — самый высокий уровень инфраструктурной иерархии в Yandex Cloud. В Организации содержатся облака (cloud), в них папки (folder), а в папках ресурсы: ВМ, Kubernetes и так далее.</p></div></details><p>Эти задачи стали нашим ТЗ.   </p><h2>Организация облаков   </h2><p>Первым делом нужно было продумать структуру нашей Организации и ролевую модель. Кого пускать, куда пускать, как организовывать командам ресурсы и как выдавать права.</p><p>Решили, что выделим каждому <strong>трайбу</strong> по два облака (cloud): для прода (prod) и для всего остального (non-prod). За продом особый догляд и более строгие доступы. На non-prod, в котором можно расположить дев, тест и любого рода экспериментальные площадки, воздух свободнее: больше прав, легче доступы и можно творить что хочешь.</p><details class="spoiler"><summary>Hidden text</summary><div class="spoiler__content"><p>Трайб — нечто вроде «департамента» в Agile-мире. Каждый трайб в ОТП отвечает за определённое направление развития, выполняет свои задачи и выпускает свой продукт. Наш трайб, IT4IT, разрабатывает внутренние продукты и решения. Так мы помогаем трайбам, которые создают бизнес-продукты, работать эффективнее.   </p></div></details><p>В итоге список Облаков у нас выглядит примерно так:</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/700/3e0/735/7003e0735d913baec35006a207ca359d.jpg" height="636" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/700/3e0/735/7003e0735d913baec35006a207ca359d.jpg" width="1344"/></figure><p>В ней всё, относящееся к интеграции нашей инфраструктуры и инфраструктуры Yandex Cloud. Здесь как минимум располагаются сервисные аккаунты (Service Account) для раздачи прав на облако, внутренние и кастомные DNS-зоны и, конечно, сердце облака — VPC.</p><p>VPC (Virutal Private Cloud) — это особый объект, который даёт возможность создавать в облаке подсети. С его помощью также поддерживается сетевая связность с нашей внутренней банковской инфраструктурой и обеспечивается DNS с возможностью создания кастомных записей, видимых внутри всего банка. Подробнее о том, как это работает и как мы это сделали, расскажем дальше в статье.</p><p>Поскольку папка infra такая важная, она для опытного пользователя выглядит натурально как большая красная кнопка «Удалить прод». К счастью, её нажать не так просто: нельзя удалить папку, если в ней есть объекты, и нельзя удалить VPC, если в нём есть подсети. Это стандартные механизмы защиты «от дурака» со стороны Yandex Cloud.</p><h2>Чтобы никого не выпускать, надо кого-то впустить   </h2><p>Чтобы хорошенько закрыть публичное облако, необходимо настроить аутентификацию нашими средствами, без доступа к интернету, то есть без использования Yandex ID. Для этого есть готовое решение: ADFS, Active Directory Federation Service. В принципе, поскольку мы пришли за аутсорсом Ops, нашим девизом было изобретать как можно меньше — поэтому тут мы погрузились в <a href="https://cloud.yandex.ru/docs/organization/tutorials/federations/integration-adfs#configure-sso">документацию</a>.</p><p>Итак, с ADFS мы заходим по специальной ссылке на страничку Yandex Cloud, вводим Federation ID и получаем страницу домена, логин, пароль — прямо как дома.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/06d/f2b/f57/06df2bf57f60bad7ffbafcfc1a8c57e8.jpg" height="702" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/06d/f2b/f57/06df2bf57f60bad7ffbafcfc1a8c57e8.jpg" width="1362"/></figure><p>Все зашедшие пользователи будут видны на специальной странице, где отображаются все пользователи организации.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/414/41d/908/41441d908895c3ec7cbd79d50ccb09f1.jpg" height="686" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/414/41d/908/41441d908895c3ec7cbd79d50ccb09f1.jpg" width="852"/></figure><h2>Аутентификация — это только начало</h2><p>Защищённый вход в облако сделали. Но дальше встаёт вопрос прав и их распределения между юзерами. У каждого трайба здесь свои представления о прекрасном и правильном. Кому-то нужно, чтобы у разработчиков были права для развёртки Kubernetes, кто-то считает, что это исключительно прерогатива DevOps-инженера, кто-то хочет дополнительные роли для QA-инженеров или проджект-менеджера и так далее.</p><p>Настраивать роли вручную не очень хотелось: мы бы просто захлебнулись в волне запросов на создание групп в AD и их ассоциацию с ролями в облаке. Решили вопрос так: для каждого облака в AD есть две группы — привилегированные и не очень. При этом привилегированные могут — и должны — раздавать роли «простым смертным» так, как они считают правильным.</p><p>У привилегированных — по сути админов облака (cloud) — роль editor (редактора) на уровне облака и роль admin на все папки (folder в терминологии Яндекса). А остальные? Они получают только членство в организации, роль resource-manager.clouds.member. То есть право суметь залогиниться в облаке.</p><p>Пользователь с такими правами, залогинившись, ни одного облака не увидит. Зато он будет числиться в федерации. И привилегированные юзеры — а это самые доверенные люди ОТП: техлиды, главные девопсы, чаптер-лиды — смогут самостоятельно настроить права для него и других обычных пользователей своего трайба.</p><p>Это можно сделать через интерфейс Yandex Cloud или, если есть умение и желание, с помощью самостоятельной автоматизации через скрипт + API, Terraform или Pulumi. Права админы распределяют своим подопечным в соответствии с ролевой моделью в Yandex Cloud и своими пожеланиями.</p><p>Для каждого облака получается такая ассоциация:</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/b1e/73a/00f/b1e73a00f23fd41430d1fff2c15ac6f2.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/b1e/73a/00f/b1e73a00f23fd41430d1fff2c15ac6f2.jpg" width="1380"/></figure><p>У нас также есть третья правовая категория — люди с пропуском на все облака. Такие права нужны прежде всего сетевикам, которые обеспечивают интеграцию облаков в сеть банка, и безопасникам — для аудита.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/268/713/1c1/2687131c150a355daa5da9de2568b629.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/268/713/1c1/2687131c150a355daa5da9de2568b629.jpg" width="1380"/></figure><p> </p><h2>Строим автоматизацию выдачи ролевой модели</h2><p> </p><p>Группы в AD можно заказывать в нашем случае по стандартным заявкам на доступы. Но у Yandex Cloud на момент реализации не было встроенного механизма, который мог бы сопоставить группы в AD со своей ролевой моделью. Сейчас это решается за счёт <a href="https://cloud.yandex.ru/docs/organization/operations/manage-groups">управления группами пользователей</a>. А мы в тот момент написали для этого свою собственную автоматизацию.</p><p>Такая автоматизация должна:</p><ol><li><p>Выбрать юзеров из AD, относящихся к работе с Yandex Cloud.</p></li><li><p>Выдать им права в облаках в соответствии с этими группами.</p></li></ol><p>Первый пункт можно сделать скриптом, второй — с помощью Terraform. Так как первая версия сервиса создавалась для Windows, мы решили, что в AD будем лазить через Powershell, а права назначать с Terraform, благо для него у Yandex Cloud есть официально поддерживаемый провайдер.</p><p>Идея в том, что Powershell сформирует для Terraform values.tf и после этого запустит terraform apply. Terraform может оперировать только ID пользователей, состоящих в федерации, поэтому у Powershell получаются три задачи:</p><ol><li><p>Найти юзеров в AD.</p></li><li><p>Для каждого юзера выяснить ID в Yandex Cloud (Federation User ID).</p></li><li><p>Сформировать для Terraform значения в удобном для него формате.</p></li></ol><p>Итог работы Powershell в формате JSON:</p><pre><code class="json">{
  "variable": {
    // права для "простых смертных"
    "tribes": {
      "default": {
        // облака
        "tribeA-prod": {
          // права
          "admins": [
            // юзера или сервисный аккаунты (Service Account)
            "federatedUser:xxxxxxxxxxxx",
            "serviceAccount:xxxxxxxxxxxx",
          ],
          "users": [
            "federatedUser:xxxxxxxxxxxx",
            "federatedUser:xxxxxxxxxxxx",
          ]
        },
        "tribeA-nonprod": {
          "admins": [
            "federatedUser:xxxxxxxxxxxx",
            "serviceAccount:xxxxxxxxxxxx",
          ],
          "users": [
            "federatedUser:xxxxxxxxxxxx",
            "federatedUser:xxxxxxxxxxxx",
          ]
        },
        // ... и далее для всех облаков  ...
      },
      // группа для сетевиков
      "org_network_admins": {
        "default": [
          "federatedUser:xxxxxxxxxxxx",
          // ... etc ...
        ]
      },
      // группа для безопасников
      "org_viewers": {
        "default": [
          "federatedUser:xxxxxxxxxxxx",
          // ... etc ...
        ]
      }
    }
  }
}</code></pre><p>В Terraform, соответственно, есть определения не всех, но значительного количества ролей:</p><pre><code class="json">variable "tribe_admin_priveleges" {
  default = {
    cloud  = ["editor", ]
    folder = ["admin"]
  }
  type = map(list(string))
}

variable "tribe_user_priveleges" {
  default = {
    cloud  = ["viewer", ]roles
    folder = []
  }
  type = map(list(string))
}

variable "org_noc_priveleges" {
  default = {
    org    = ["vpc.admin","viewer"] 
    cloud  = []
    folder = []
  }
  type = map(list(string))
}

variable "org_viewer_priveleges" {
  default = {
    org    = ["viewer"]
    cloud  = []
    folder = []
  }
  type = map(list(string))
}</code></pre><p>Всё вместе это собирается примерно так. Показываем на примере создания ролей на уровне облаков:</p><pre><code class="json">#### Cloud level #########

# Подготовка данных перед выдачей прав
locals {
  ### Маппинги списка пользователей на роли, которые им нужно выдать 

  # Маппинг ролей безопасников и сетевиков
  cloud_noc_mapping                     =setproduct(var.org_network_admins,var.org_noc_priveleges["cloud"])
  cloud_viewer_mapping                  =setproduct(concat(var.org_viewers,var.sa_org_viewers),var.org_viewer_priveleges["cloud"])

  # Маппинг юзеров трайбов
  all_tribes_clouds_mapping = chunklist(flatten([for cl in local.clouds: 
    concat(
      setproduct(var.tribes[cl.name].users,var.tribe_user_priveleges["cloud"],[cl.cloud_id]),
      setproduct(var.tribes[cl.name].admins,var.tribe_admin_priveleges["cloud"],[cl.cloud_id])
    )
    if contains(keys(var.tribes),cl.name)
  ]),3)

  all_clouds_mappings = chunklist(
    flatten(
      setproduct(
        concat(
          local.cloud_noc_mapping,
          local.cloud_viewer_mapping,
          )
        ,local.clouds.*.id)
      )
    ,3)
}
# Собственно выдача права - это создание объектов типа CloudIamBinding для каждого юзера
resource "yandex_resourcemanager_cloud_iam_binding" "cloud_binding" {
   # Финальный хак - формируем словарь
   # Где ключ строка "&lt;cloud_id&gt;/&lt;role_name&gt;", а значение - ID пользователя или сервисного аккаунта
  for_each = {for v in concat(local.all_clouds_mappings,local.all_tribes_clouds_mapping):
    "${v[2]}/${v[1]}" =&gt; v[0]...
  }
  cloud_id = split("/",each.key)[0]
  role     = split("/",each.key)[1]
  # Выдаются права сразу пачке пользователей
  members  = each.value
}</code></pre><p>На уровне Организации и папок всё сделано аналогично.</p><p>В этом коде есть особенность (конечно, помимо того, что трансформация данных в Terraform — это адский ад). Здесь использован ресурс cloud_iam_binding, а не cloud_iam_member. Дело в том, что в Yandex Cloud список пользователей привязывается к роли, а не наоборот, как это может показаться, например, при взгляде в графический интерфейс. Эта привязка полностью описывается объектом *_iam_binding.</p><p>Соответственно, если кто-то где-то в другом месте попробует изменить роли — сервис, который работает по таймеру, перезапишет это и вернёт права как было. Это нужно на случай непредвиденной эскалации прав или, наоборот, случайного их удаления.</p><p>Мы настроили использование *iam_binding на уровне облака и Организации (cloud_iam_binding и organization_iam_binding соответвенно), чтобы чётко фиксировать права на уровне Организации и облаков. На уровне папок же сервис использует folder_iam_member, который способен «мягко» добавить пользователя в существующий биндинг без перезаписи. Это важно: админам нужна возможность самостоятельно выдать права рядовым членам команды и быть уверенными, что наш сервис их не перезатрёт.</p><p>Сервис выдачи прав создавался на самой заре захода в Yandex Cloud, когда очертания того, как всё у нас будет устроено, были весьма туманными. Со временем стало ясно, что связка Powershell + Terraform получается плохо читаемой и сложно поддерживаемой.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/287/c21/d8f/287c21d8f92836cf3392494341127b28.jpg" height="846" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/287/c21/d8f/287c21d8f92836cf3392494341127b28.jpg" width="1200"/></figure><p>Сейчас в техдолге у нас есть живая задача — хорошенько отрефакторить этот сервис. Для инфраструктурного кода мы в трайбе используем Pulumi. С его помощью можно будет оформить и работу c AD, и работу с ресурсами Yandex Cloud в одну программу. Это сильно облегчит нам поддержку.</p><details class="spoiler"><summary>Hidden text</summary><div class="spoiler__content"><p>Опыт создания этого сервиса через Terraform — одна из причин, почему мы в нашем трайбе решили попробовать Pulumi. Pulumi, используя под капотом провайдеры от Terraform, позволяет писать инфраструктурный код на нормальном языке программирования. Те же ресурсы как и в Terraform — даже имена и свойства ресурсов те же самые! — только на полноценном объектно-ориентированном ЯП по выбору (TypeScript, Golang, C#, Java и так далее).</p><p> Соответственно, к твоим услугам вся мощь современной разработки: нормальная IDE, дебаг, любые библиотеки, возможность создания красивых абстракций. И конкретно, например, для задачи с автоматизацией выдачи прав это даёт возможность запаковать и работу с AD, и маппинг, и создание ресурсов в одну программу.</p></div></details><h2>Все зашли в облако… и сразу вышли   </h2><p>Потому что нет сетевой связности ни с интернетом, ни с нашими внутренними сетями. Публичный интернет закрыт квотами и отсутствием возможности сделать SNAT (source NAT) в подсетях, а с внутренней инфраструктурой нет физической связности.</p><p>То есть если мы создадим подсеть в облаке, она будет существует в вакууме. Можно развернуть виртуалки и даже Kubernetes PaaS, но существовать они будут в пузыре, без какой бы то ни было связности со внешним миром.</p><p>Инженеры Yandex Cloud для организации сетевой связности с нашей приватной инфраструктурой предложили использовать <a href="https://cloud.yandex.ru/docs/interconnect/concepts/">Yandex Cloud Interconnect</a><u>.</u> После прочтения документации по нему стало ясно, что надо звать сетевиков: без их черной магии дело дальше не пойдёт.</p><h2>Как в итоге всё решилось?</h2><p>Наше оборудование стоит в ЦОДе рядом с оборудованием Яндекса и физически подключено к нему. Между ними настроен BGP-пиринг, и они обмениваются маршрутами. Таким образом наша инфраструктура видит сети в облаках, а облака, соответственно, нашу инфраструктуру.</p><p>Для обеспечения отказоустойчивости физический стык продублирован во втором ЦОДе, и оба канала работают в режиме active-active-балансировки через BGP.</p><p>Подробности об этой сетевой магии можно прочитать в документации по ссылке выше.</p><p>Для обеспечения связности помимо физического стыка нужен финальный штрих — это настройка VPC конкретного облака. Для этого наши сетевики приходят во вновь созданные облака и договариваются с техподдержкой Yandex Cloud о новых анонсах для VPC этого облака. Для каждого облака анонсятся три диапазона — по диапазону на каждый ЦОД — и после этого подсети, созданные из VPC этого облака, получают связность с нашей внутренней инфраструктурой. Именно для этих работ сетевикам и нужен пропуск и особые доступы, о которых писалось выше.</p><p>И кстати, здесь же и реализуется одно из главных желаний безопасников: любой трафик, который выходит из облака, проходит через наши файрволы.</p><h2>Как же пользоваться всем этим хозяйством обычному пользователю?   </h2><p>Простой ответ на этот вопрос будет таким: «Видишь, пользователь, на картинке три больших /21 диапазона? Они твои. Создавай внутри них подсети (Subnet) в строгом соответствии с ЦОДом, которому они принадлежат, и у тебя все будет хорошо».</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/34a/0ec/03c/34a0ec03c5fbb783486eb86be065ab4d.jpg" height="670" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/34a/0ec/03c/34a0ec03c5fbb783486eb86be065ab4d.jpg" width="1530"/></figure><p>И более развернутый ответ:</p><p>В каждом облаке есть три больших /21-диапазона (фиолетовая рамка с подписью VPC). Каждая такая подсеть закреплена за отдельным ЦОДом. Второй октет этой сети обозначает ЦОД. Так, на картинке 10.101.х.х — это ЦОД ru-central1-a, 10.102.х.х — это ЦОД ru-central1-b и так далее.</p><p>Эти /21-подсети полностью виртуальны. Они нигде в интерфейсе не фигурируют и прописаны где-то глубоко внизу на инфраструктуре Яндекса и нашей. Внутри них можно создать подсеть — и они будут маршрутизироваться как внутри облака, так и внутри приватной инфраструктуры. Можно завести подсеть сразу на весь диапазон, но мы рекомендуем нарезать сети поменьше — скажем, /24-диапазоны.</p><p>Если всё правильно создать, то можно начать всячески развлекаться — создавать виртуалки, Kubernetes и так далее — и всё будет иметь сетевую связность с банком.</p><p>Если подумать ещё немного дальше, то для красоты, читаемости и обеспечения возможности создавать катастрофоустойчивые приложения, лучше сразу создавать сети «тройняшки». То есть «зафиксировать» третий октет за командой или информационной системой и сделать её копии для каждого ЦОДа. Такие сети на картинке выше выделены цветами: синие для команды А, зелёные — для команды (или системы) C. Обратите внимание: у всех «тройняшек» один третий октет и разный второй.</p><p>В таких «тройняшках» удобно развёртывать кластеризированные системы, «размазывая» их по трём зонам доступности. Это как раз одна из киллер-фич, за которыми мы пришли в публичное облако.</p><p>Из минусов этой системы сейчас видим только один — это необходимость сообщать командам /21-диапазоны их облаком и объяснять, как правильно создавать подсети. Со стороны Yandex Cloud это, к сожалению, нигде не отображается, и мы не нашли возможность это как-то ограничить. Командам просто это нужно знать.</p><p>Далее последним желанием отдела безопасности остался аудит. Для него мы использовали готовый сервис Yandex Audit Trails. Он следит за всей Организацией и складывает в бакет отчёты о том, что происходит в облаке. И всё бы хорошо, но…</p><h2>Аудит и SIEM</h2><p>Мы обнаружили, что наша SIEM не умеет работать с бакетами напрямую. В документации Яндекса не было описания случая, целиком аналогичного нашему. Но концепция не была уникальной: просто пришлось копнуть чуть поглубже.</p><p>Как подключить разные SIEM — описано в <a href="https://cloud.yandex.ru/docs/audit-trails/tutorials/trails-logs-elasticsearch">этом</a> разделе документации. Нашей SIEM там нет, так что мы чуть-чуть импровизировали. Сделали промежуточную ВМку, в которую этот бакет монтировали с помощью GeeseFS по <a href="https://cloud.yandex.ru/docs/storage/tools/geesefs">инструкции</a>.</p><p>По итоговой схеме Audit Trails складывает отчёты с событиями в наш бакет, этот бакет смонтирован на ВМ, а наша SIEM ходит к ней по SSH и забирает отчёты просто из файловой системы.</p><p>Концептуальная схема выглядит так:</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/04d/cde/e1a/04dcdee1a247463f39211b88b3c9412b.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/04d/cde/e1a/04dcdee1a247463f39211b88b3c9412b.jpg" width="1380"/></figure><p>Порядок действий, чтобы это всё заработало, примерно следующий:</p><ol><li><p>Создать Audit Trails.</p></li><li><p>Создать Service Account (SA) и выдать ему права на работу с Audit Trails и чтение из бакета.</p></li><li><p>Создать виртуальную машину (ВМ), куда будет смонтирован бакет. Важно, чтобы к ВМ был «подключен» сервисный аккаунт.</p></li><li><p>Настроить GeeseFS, чтобы он монтировал бакет по нужному пути.</p></li><li><p>Настроить SSH.</p></li></ol><p>Создать Audit Trails можно по инструкции: https://cloud.yandex.ru/docs/audit-trails/quickstart</p><p>Выдать права SA через CLI можно так:</p><pre><code class="bash"># Права на уровне ПАПКИ: storage.uploader, storage.viewer
yc resource-manager folder add-access-binding --name my-folder --service-account-name audit-trails --role storage.uploader
yc resource-manager folder add-access-binding --name my-folder --service-account-name audit-trails --role storage.viewer
 
### Выдать права сервисному аккаунту на просмотр событий аудита на уровне организации
# Права на уровне ОРГАНИЗАЦИИ: audit-trails.viewer
# WARNING! Это можно сделать только из-под пользователя или SA, которые имеют права админа на всю организацию
yc organization-manager organization add-access-binding --role audit-trails.viewer --id "&lt;ORG ID&gt;" --service-account-id "&lt;SA ID&gt;"</code></pre><p>Виртуалку можно создать любую. Главное — указать ей «связь» с созданным SA. Об этом можно почитать в официальной инструкции <a href="https://cloud.yandex.ru/docs/compute/quickstart/quick-create-linux">Создание виртуальной машины Linux</a>, поискав по слову доступ.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/ce8/94c/dd5/ce894cdd585381941ba27df70b4054f6.jpg" height="413" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/ce8/94c/dd5/ce894cdd585381941ba27df70b4054f6.jpg" width="733"/></figure><p>Это полезно, потому что на виртуалке будут созданы приватные ключи для работы из-под этого SA. Это нам дальше упростит монтирование бакета.</p><p>Само монтирование выглядит так:</p><pre><code class="bash"># Доступа в интернет нет, поэтому пререквизиты для нас
# Это настроить пакетные репозитории на наш Nexus (хранилище и прокси для артефактов)
sed -i 's/^mirrorlist=http:\/\/mirrorlist.centos.org/#&amp;/' /etc/yum.repos.d/*.repo
sed -i 's|^#\?baseurl=http://mirror.centos.org|'baseurl=http://nexus.our'|g' /etc/yum.repos.d/*.repo

## Установить вспомогательные утилиты для маунта S3 бакетов
sudo dnf install -y fuse fuse-utils

## Установить geesefs
# И бинарник скачиваем через проксю в Nexus
sudo curl -LO https://nexus.our/github-raw-proxy/yandex-cloud/geesefs/releases/latest/download/geesefs-linux-amd64 --output /usr/local/bin/geesefs
sudo chmod +x /usr/local/bin/geesefs

## Создать сам маунт
# Такой маунт безопасен и не приведет к падению при старте ОС, даже если будет ошибка подключения к бакету. Просто в journalctl будет запись об ошибке маунта
sudo echo "audit-trails-bucke-name /path/to/mount fuse.geesefs _netdev,allow_other,--iam,--subdomain 0 0" &gt;&gt; /etc/fstab
## В команде выше два флага, которых нет в официальных примерах:
# --iam - воспользоваться сервисным аккаунтом, связанным с ВМ. Помните, выше мы привязывали его к ВМ? Как раз для этого. Иначе нам бы пришлось добавлять AWS Credentials файл с ключами доступа к бакету.
# --subdomain - обращаться к бакету исключительно по доменному имени. Так называется virtual-domain-style (в противовес deprecated path-style — обращение по путем). Обращение по домену для нас очень важно, потому что только так в наших условиях будут работать сетевые доступы до бакета.

# Финальный штрих =)
sudo mount -a</code></pre><details class="spoiler"><summary>Hidden text</summary><div class="spoiler__content"><p>Под капотом — ключ сервисного аккаунта для ВМ получается довольно любопытным образом. Если была сделана привязка SA к ВМ, достаточно сделать изнутри ВМ запрос на особый адрес:</p><p> # Запрос токена...</p><p>curl -H Metadata-Flavor:Google http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token</p><p> # И ответ будет примерно такой</p><p>{"access_token":"CggVAgAAA...","expires_in":39944,"token_type":"Bearer"}</p><p>169.254.0.0/21 — это специальный зарезервированный диапазон для локальных обращений. Dynamically configured link-local addresses — <a href="https://www.rfc-editor.org/rfc/rfc3927">RFC3927</a>. И в нём есть адрес 169.254.169.254, который многие облака используют для внутренних нужд. Google, AWS и вот теперь Yandex Cloud расположили на нём сервис получения метаданных ВМ. Более подробный пример смотрите здесь: <a href="https://cloud.yandex.ru/docs/compute/operations/vm-connect/auth-inside-vm">Работа с Yandex Cloud изнутри виртуальной машины</a>.</p></div></details><h2>Kubernetes</h2><p>Kubernetes в нашем облаке можно создать, до его API можно достучаться, у нод есть сетевая связность с банком… но в нём нельзя развернуть ни одно приложение!</p><p>Всё дело в доступах. Интернета нет, значит, нет ни регистри Яндекса, ни тем более docker.io и сотоварищей. Есть доступ до нашего Nexus… Однако на нём самоподписанные сертификаты — и Kubernetes, а точнее container runtime под ним, строго требует TLS и не позволяет скачать ни одного образа.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/8df/5b6/689/8df5b668995edc70316759488bba129e.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/8df/5b6/689/8df5b668995edc70316759488bba129e.jpg" width="1380"/></figure><p>Выход? Подложить свои сертификаты на все ноды кубера. Свой образ ВМ под кубер использовать нельзя, кастомизировать под нас образ в Yandex Cloud тоже не будут. Мировое комьюнити подобного рода задачи — допиливание образов Kubernetes PaaS — решает с помощью DaemonSet.</p><p>Однако, чтобы подложить сертификаты, нужно запустить в кубере какой-то образ… Который, как мы уже выяснили, ниоткуда нельзя скачать! Единственная возможность — это сделать, когда нет доступов вообще ни к какому регистри — использовать образы, которые уже есть на нодах Kubernetes. Таким образом, например, может быть один из компонентов самого Kubernetes, которые зашиваются прямо в образы нод. Для начала мы взяли kube-proxy.</p><p>Сделали Helm-чарт, в нём DaemonSet, который запускает поды на каждой ноде из этого образа и выполняет наш скрипт-напильник. Мы обозвали этот чарт node-init.</p><p>Без проблем, конечно, не обошлось.</p><h2>Containerd не видит сертификатов без перезапуска</h2><p>У containerd есть конфиг по пути в /etc/containerd/config.toml. В нём есть много интересного, что специалисты Yandex Cloud туда записали. А вот чего в нём нет, так это особой записи, которая позволяет подложить в определённую папку свои сертификаты, чтобы containerd начинал им пользоваться без перезапуска. Я говорю о такой записи:</p><pre><code class="python">[plugins."io.containerd.grpc.v1.cri".registry]
   config_path = "/etc/containerd/certs.d"</code></pre><p>Поэтому в нашем скрипте для раскладывания сертификатов есть специальный кусок кода, который рестартует containerd один раз за время жизни ноды:</p><pre><code class="bash">echo "==== Optional containerd restart enabled. Restart containerd and dockerd. ===="
# /host — это маунт хостовой рутовой файловой системы в под.
# Таким образом под получает возможность управлять хостом через chroot /host
set -x
NODE_INIT_DIR=/host/opt/node-init
mkdir -p "${NODE_INIT_DIR}"
# файлы-флаги рестарта containerd, dockerd (см. ниже)
NODE_INIT_CONTAINERD_RESTARTED=$NODE_INIT_DIR/containerd.restarted
NODE_INIT_DOCKERD_RESTARTED=$NODE_INIT_DIR/dockerd.restarted
set +x

if [ ! -f "${NODE_INIT_CONTAINERD_RESTARTED}" ]; then
   echo "Restart Containerd..."
   # Так как рестартовать containerd при каждом рестарте пода node-init мягко говоря опасно
   # то добавляем специальный файл флаг, который говорит «нода уже инициализирована»
   # Флаг добавляется перед рестартом, чтобы избежать бесконечного цикла в случае неуспешного рестарта
   touch "$NODE_INIT_CONTAINERD_RESTARTED"
   chroot /host systemctl restart containerd
   echo "OK!"
else echo "Containerd has been already restarted on this host."; fi;

# Когда Яндекс переходил с dockerd на containerd,
# то несколько версий они работали одновременно в странном симбиозе.
# Экспериментально выяснилось, что в таких случаях нужно рестартовать и dockerd тоже,
# даже если он сам не видит ни одного контейнера, запущенного на ноде
if [ ! -f "${NODE_INIT_DOCKERD_RESTARTED}" ]; then
   echo "Restart Dockerd..."
   touch "$NODE_INIT_DOCKERD_RESTARTED"
   chroot /host systemctl restart docker
   echo "OK!"
else echo "Dockerd has been already restarted on this host."; fi;</code></pre><details class="spoiler"><summary>Hidden text</summary><div class="spoiler__content"><p>Во время подготовки статьи техподдержка Yandex Cloud частично ответила на этот запрос. Они не внесли изменения в конфиг containerd, но зато предложили своё решение для подкладывания сертификатов с перезагрузкой. Можно посмотреть тут: <a href="https://github.com/yandex-cloud/yc-architect-solution-library/tree/main/yc-k8s-certificate-updater">https://github.com/yandex-cloud/yc-architect-solution-library/tree/main/yc-k8s-certificate-updater</a></p></div></details><h2>На нодах нет ни одного образа с фиксированным тегом</h2><p>На образе ВМ, который в Yandex Cloud используется для поднятия нод кубера, зашиты образы системных контейнеров, необходимых для первичной инициализации ноды.</p><p>Вот неполный список, который можете посмотреть и вы, если зайдёте на свежую ноду:</p><pre><code class="bash">root@xxxxxxxxx-aaaaa:/etc/kubernetes# /home/kubernetes/bin/crictl image ls
IMAGE                                                                                     TAG                 IMAGE ID            SIZE
cr.yandex/crpsjg1coh47p81vh2lc/k8s-addons/calico/cluster-proportional-autoscaler-amd64    1.7.1               14afc47fd5aff       41.3MB
cr.yandex/crpsjg1coh47p81vh2lc/k8s-addons/cilium/cilium                                   v1.12.9             b606b891645b8       421MB
cr.yandex/crpsjg1coh47p81vh2lc/k8s-addons/kube-proxy/kube-proxy                           v1.26.2             6f64e7135a6ec       114MB
cr.yandex/crpsjg1coh47p81vh2lc/k8s-addons/metrics-server/metrics-server                   v0.6.1              e57a417f15d36       70.1MB
cr.yandex/crpsjg1coh47p81vh2lc/pause                                                      3.9                 221177c6082a8       715kB
cr.yandex/crpsjg1coh47p81vh2lc/yc-disk-csi-node                                           38ef4c9376d          91b2502cca9dd       33.5MB
# и т.д.</code></pre><p>Обратите внимание, что всё сделано по лучшим практикам работы с образами: все теги, версии фиксированы, ни одного latest. Но хорошая практика в этот раз по иронии привела нас к неприятной проблеме.</p><p>Запустить node-init на кластере можно без проблем. Ты знаешь версию кластера, знаешь, что на нодах точно будет какой-нибудь kube-proxy и можешь загодя имя образа успешно сформировать.</p><p>Но… А если обновление? Теги образов поменяются, и наш node-init больше не сможет подняться на новой ноде. Проблема неприятна также тем, что со стороны Yandex Cloud регулярно вносятся изменения в образы. Они меняются даже в рамках одной минорной версии.</p><p>Например, у тебя есть кубер возрастом несколько месяцев с автоскейлингом. И в какой-то момент меняются патчевые версии системных компонентов, kubeproxy становится x.y.z+1. Наш node-init на новых нодах сразу же выходит покурить.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/66e/5d8/065/66e5d8065547dd317934a14a96cc5e2e.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/66e/5d8/065/66e5d8065547dd317934a14a96cc5e2e.jpg" width="1380"/></figure><p>Вертели проблему и так, и эдак. В итоге получалось, что без поддержки Yandex Cloud это не сделать никак. Мы сформировали тикет, и специалисты Яндекса были довольно быстры — и в течение нескольких месяцев добавили образ со стабильным тегом в релизный канал RAPID, а через полгода он перешёл в STABLE. Вот так выглядит теперь этот красавец. Скорее всего, и на вашей ноде кубера он уже есть:</p><pre><code>root@xxxxxxxxx-aaaaa:/etc/kubernetes# /home/kubernetes/bin/crictl image ls
# something...
# something...
# something...
cr.yandex/yc/mk8s-openssl                                                                 stable              8a55c996a8286       81.2MB
# dark side...</code></pre><p>Теперь можно обновляться, скейлиться... Всё будет работать. Некоторое время.</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/d3d/cc0/360/d3dcc0360032d2eed89907e90c72d1c9.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/d3d/cc0/360/d3dcc0360032d2eed89907e90c72d1c9.jpg" width="1380"/></figure><h2>Проблема GC (Kubernetes Garbage Collection)</h2><p>Здесь история с открытым финалом. У Kubernetes есть своя система <a href="https://kubernetes.io/docs/concepts/architecture/garbage-collection">Garbage Collection</a>. Подчищает много чего, но нам интереснее всего то, что он со временем удаляет с нод неиспользуемые образы.</p><p>Напомню, что в образах под кубер у Yandex Cloud зашито много разных образов. Среди них есть те, которые запускаются не на каждой ноде (coredns, metrics-server) и даже не в каждом инстансе Kubernetes (nvidia/k8s-device-plugin). Со временем эти неиспользуемые образы с некоторых нод могут исчезнуть. И если кубер решит мигрировать, например, coredns на соседнюю ноду, где этого образа никогда не было, нода полезет в cr.yandex… Где получит вечный ImagePullBackOff в статусе пода.</p><p>Недавно к нам пришла одна из команд в лице девопса и сообщила о проблеме: из их кластера исчез образ hubble-generate-certs, который используется в одной из предустановленных Job.</p><p>Также наши команды сталкивались с тем, что версия кластера и нод протухает, на них начинают пытаться автоматически встать патчевые обновления и тоже застревают на этапе скачивания образа из cr.yandex. Например, этим особо грешит почему-то CSI Yandex Cloud (поды yc-disk-csi-node-*).</p><details class="spoiler"><summary>Hidden text</summary><div class="spoiler__content"><p>Немного о процессах в нашем банке. У нас стараются по возможности придерживаться концепции InnerSource — OpenSource для внутреннего кода. Все репозитории доступны для чтения всем командам разработки, если репозиторий явно не закрыт по соображениям ИБ. Их можно форкать, а при желании можно и сделать свой PR (Pull Request) в чужой репозиторий. В проблеме с Garbage Collection Kubernetes эта система сыграла всем на руку. node-init создавали мы, трайб IT4IT, а DevOps с проблемой пришёл из совсем другого трайба. Он сразу сделал PR со своей альфа-версией реализации, и дальше мы уже исследовали проблему совместно.</p><p>Кроме того, у нас есть система гильдий — особых совместных и полностью добровольных комьюнити, посвящённых какой-то теме или технологии. Из активных у нас есть, например, гильдия Javа и гильдия Kubernetes. ОТП официально разрешает членам гильдии тратить 5% рабочего времени на её задачи. Так, например, последняя проблема по node-init решалась именно в рамках гильдии Kubernetes, без особой бюрократии в виде проведения по процессу и согласований со стороны проджект-менеджеров.</p></div></details><p>Немного о процессах в нашем банке. У нас стараются по возможности придерживаться концепции InnerSource — OpenSource для внутреннего кода. Все репозитории доступны для чтения всем командам разработки, если репозиторий явно не закрыт по соображениям ИБ. Их можно форкать, а при желании можно и сделать свой PR (Pull Request) в чужой репозиторий. В проблеме с Garbage Collection Kubernetes эта система сыграла всем на руку. node-init создавали мы, трайб IT4IT, а DevOps с проблемой пришёл из совсем другого трайба. Он сразу сделал PR со своей альфа-версией реализации, и дальше мы уже исследовали проблему совместно.</p><p>Кроме того, у нас есть система гильдий — особых совместных и полностью добровольных комьюнити, посвящённых какой-то теме или технологии. Из активных у нас есть, например, гильдия Javа и гильдия Kubernetes. ОТП официально разрешает членам гильдии тратить 5% рабочего времени на её задачи. Так, например, последняя проблема по node-init решалась именно в рамках гильдии Kubernetes, без особой бюрократии в виде проведения по процессу и согласований со стороны проджект-менеджеров.</p><pre><code class="python">[debug]
  level = "info"

[plugins.linux]
  shim = "/home/kubernetes/bin/containerd-shim"
  runtime = "/home/kubernetes/bin/runc"

[plugins.cri]
  stream_server_address = "127.0.0.1"
  enable_tls_streaming = false
  sandbox_image = "cr.yandex/crpsjg1coh47p81vh2lc/pause:3.7"
  [plugins.cri.containerd]
    snapshotter = "overlayfs"

[plugins.cri.cni]
  bin_dir = "/home/kubernetes/cni/bin"
  conf_dir = "/etc/cni/net.d"

Наша идея была в том, чтобы в начало конфига добавить строчку
imports = ["/etc/containerd/client_*.toml"]

И рядышком положить наш конфиг в /etc/containerd/client_otp.yaml
[plugins.cri.registry.mirrors]
    [plugins.cri.registry.mirrors."cr.yandex"]
      endpoint = ["https://nexus.our"]</code></pre><p>Сначала вроде всё работало. Мы уже хотели идти к ребятам из Yandex Cloud и просить добавить в config.toml такой импорт, чтобы все клиенты могли по желанию расширять конфиг containerd. Но оказалось, мы рано обрадовались.</p><p>Совершенно внезапно выяснилось, что containerd не делает глубокого мерджа своих секций. Если в импорте, как у нас, была затронута хоть чуть-чуть секция plugins.cri, то он всю её перезаписывает!</p><p>Получается, что мы добавили только зеркала, но с точки зрения containerd — это полноценная секция, где все остальные значения, кроме зеркал — значения по умолчанию.</p><p>Итоговый конфиг containerd выглядел после нашего импорта таким образом (сильно сокращённый вариант):</p><p>Команда на получение текста рабочего конфига: sudo containerd config dump.</p><pre><code class="python"># ... something ...
[plugins."io.containerd.grpc.v1.cri"]
   # ...
   sandbox_image = "registry.k8s.io/pause:3.6"
   # ...

[plugins."io.containerd.grpc.v1.cri".cni]
   bin_dir = "/opt/cni/bin"
   conf_dir = "/etc/cni/net.d"
   # ...
# ... etc ...</code></pre><p>Обратите внимание, что sandbox_image стал ссылаться на официальный регистри Kubernetes вместо cr.yandex, а пути к бинарникам cni стали стандартными.</p><p>Ожидания на умный мердж by-key у нас не оправдались: containerd мерджит по секциям. Народ <a href="https://github.com/containerd/containerd/issues/5837">ругается</a> об этом в GitHub с 2021 года.</p><p>Мы, конечно, можем повторить в своём конфиге стандартный конфиг Yandex Cloud, который есть сейчас… А что, если его изменят во время обновления?</p><p>Получается, мы не можем делать import. Поэтому сейчас мы варварствуем и делаем нечто подобное:</p><pre><code class="python">if [ $(grep -Pzoc '\[plugins.cri.registry.mirrors."cr.yandex"\]' config.toml) -eq 0 ]; then
  cat &gt;&gt; config.toml &lt;&lt;EOF
[plugins.cri.registry.mirrors."cr.yandex"]
  endpoint = ["https://nexus.our"]
EOF
fi;</code></pre><p>У нас получается конфиг Yandex Cloud с добавлением в конец нашего зеркала.</p><p>Решение кажется предельно костыльным и очень опасным. Мы висим на краю, любое обновление конфига со стороны Yandex Cloud при обновлениях нам может поломать кластера. Так почему нам просто не сделать уже эти доступы до cr.yandex? Две причины:</p><ol><li><p>Организационная. Централизованный инструмент для хранения и проксирования артефактов у нас — наш Nexus. Он контролируется и мониторится Управлением информационной безопасности (УИБ), на нём есть наши сканеры. Репозиторий Yandex Cloud находится вне периметра и поэтому считается опасным.</p></li><li><p>Техническая. Наш ИБ всегда готов идти на уступки в случае реальной необходимости, но мешает техническая проблема. Под капотом Yandex Cloud Registry использует      редиректы на Object Storage. По ряду причин наш файрвол испытывает трудности при дешифровке S3-подобного трафика, и скорость скачивания неприлично падает: 70 Мб могут скачиваться 20 минут.</p></li></ol><p>Сейчас историю с модификацией конфига containerd мы используем как временный workaround, пока не найдём другой выход.</p><h3>DNS</h3><p><strong>Состояние DNS, которое у нас было в самом начале:</strong></p><ol><li><p>Внутри облака можно ресолвить имена всех ресурсов этого облака.</p></li><li><p>Ресурсы банка можно ресолвить, если в настройках подсетей прописать наш корпоративный DNS.</p></li><li><p>Из одного облака нельзя ресолвить ресурсы другого облака.</p></li><li><p>Из банка нельзя ресолвить ничего, что находится внутри облаков.</p></li><li><p>Postgres PaaS общается только по доменным именам и не даёт IP.</p></li></ol><p>Пункты 3 и 4 неприятны, но с ними можно худо-бедно жить. Хоть и не очень хорошо, прямо скажем. Но вот последний — прямо ахтунг. Поэтому мы начали искать возможность сделать хороший глобальный DNS, чтобы все и отовсюду могли друг друга ресолвить.</p><p>В каждом облаке за DNS отвечает ресурс VPC — то самое «сердце облака», через которое мы делали сетевую связность с нашей инфрой. DNS этого VPC по умолчанию содержит внутренние зоны Yandex Cloud, которые хранят адреса ВМ и PaaS, и позволяет создавать кастомные зоны. Но что важно — только в рамках этого облака! Однако у VPC обнаружилась очень крутая фича, которая позволяет делать пиринг с зонами в других VPC, то есть других облаков. В терминологии Яндекса это называется «общая зона видимости». Зона видимости делает синхронизацию записей между облаками.</p><p>Получается, мы можем все зоны всех других облаков (всех VPC в них) спирить в одну глобальную — так, как нарисовано на схеме:</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/811/4d6/9a4/8114d69a47eac3d608df46294396497d.jpg" height="776" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/811/4d6/9a4/8114d69a47eac3d608df46294396497d.jpg" width="1380"/></figure><p>Пиринг зон возможно сделать только через Yandex CLI:</p><pre><code class="bash">yc dns zone update &lt;source_dns_zone_id&gt; --network-ids="&lt;source_vpc_id&gt;,&lt;target_vpc_id&gt;"</code></pre><p>target_vpc_id — VPC техклауда. Так мы обозвали наше специальное облако, созданное для обслуживания всей интеграции с Yandex Cloud, в том числе DNS. </p><p>source_vpc_id — VPC облака, в котором нам нужны записи. Это будет облако трайба. Те облака, где люди работу работают. </p><p>source_dns_zone_id — зона, которую нужно добавить.</p><p>Одно облако — одна зона. Поэтому команду придётся выполнять для каждого облака (точнее — для каждого VPC, но у нас это по сути равнозначные понятия, потому что на одно облако — одна VPC).</p><p>Задача вроде одноразовая, но руки чешутся автоматизировать. Руки чесались у потомственного Windows-админа, поэтому вот вам скрипт на Powershell:</p><pre><code class="powershell">## пререквизиты: YC CLI должен работать из-под админа Организации

$allClouds=((yc resource-manager cloud list --format json)|convertfrom-json)

# сформировать список всех VPC нашей Организации
$allvpcid=@()
foreach($cloud in $allClouds){
   # достать системную папку infra и VPC в ней
   $folder = (yc resource-manager folder get infra --cloud-id $cloud.id --format json|convertfrom-json)
   $vpc = (yc vpc network list --folder-id $folder.id --format json | convertfrom-json)
   "$($cloud.name) - $($vpc.name)"
   # сложить в массив allvpcid
   if($vpc.id){
      $allvpcid += $vpc.id 
   }
}

# Все внутренние зоны Яндекса в техклауде (ВМ, PaaS, обратные),
   # Исключаем internal и 10.in-addr.arpa.
   # В результате останутся зоны
   # mdb.yandexcloud.net. (Database as a Service), 
   # ru-central1-internal (ВМки)
   # три обратные зоны {101-103}.10.in-addr.arpa  (см. выше про сети, это те самые диапазоны, которые выделяли под каждый ЦОД в Яндексе)
$tech_cloud_infra = "xxxxxxxxxxxxxx" # ID папки infra в нашем техклауде
$zones = (yc dns zone list --folder-id $tech_cloud_infra --format=json | convertfrom-json)|?{$_.zone -ne 'internal.' -and $_.zone -ne '10.in-addr.arpa.'}

# Форматируем список для прокидывания в YC CLI
# нужна строка с ID всех VPC, через запятую
$network_ids = $allvpcid -join ','
foreach($zone in $zones){
   # создаем зону видимости (то что я обозвал выше пирингом) 
   # между зоной в техклауде и всеми VPC организации
   # команда идемпотентная, можно выполнять много раз
   # для каждой зоны делаем общую видимость (пиринг) с такими же зонами в других облаках
   yc dns zone update $zone.id --network-ids=$network_ids
}</code></pre><p>Результат манипуляций выше: все имена всех ВМ и PaaS становятся видны в VPC техклауда.</p><p>Здесь была забавная история. Мы не ожидали подвоха, но, оказывается, в Yandex Cloud было ограничение: можно было спирить друг с другом не более 5 VPC. Сначала новости от Яндекса были тревожными: они говорили о технической сложности расширения лимита. Был шанс, что наша затея провалится, но всё обошлось, специалисты Yandex Cloud через несколько месяцев расширили нам лимит до 100 возможных зон видимости.<br/> <br/>Забавно то, что, получается, никто до нас не пробовал провернуть такую схему на больших масштабах — в итоге мы спирили в наш техклауд около 30 облаков.</p><h2>Бонус для разработчиков: собственная зона в каждом облаке</h2><pre><code class="powershell"># Все облака
$allclouds = (yc resource-manager cloud list --format json|convertfrom-json)
foreach ($cloud in $allclouds){
   # В этом облаке получаем папку infra, в ней VPC и кастомную зону 
   $folder = (yc resource-manager folder get infra --cloud-id $cloud.id --format json|convertfrom-json)
   #VPC текущего облака в виде объекта
   $vpc = (yc vpc network list --folder-id $folder.id --format json | convertfrom-json) 
   # Создаем кастомную зону в каждом облаке
   $cloudCustomZoneName = "$($cloud.name).yc.our."
   yc dns zone create --zone "$cloudCustomZoneName" --private-visibility --network-ids $vpc.id --folder-id $folder.id --name $cloud.name
   $zone=(yc dns zone list --folder-id $folder.id --format json |convertfrom-json)|?{$_.zone -like "$cloudCustomZoneName"}

   # И создаем зону видимости (пиринг) с техклаудом
   if($zone.id.count -eq 1 -and $zone.zone -ne 'ynd-tech-cloud'){
      yc dns zone update $zone.id --network-ids="$($vpc.id),enp0p245kbph70biceku"
   }
}</code></pre><p>Теперь разработчики и девопсы в каждом облаке могут создавать себе самостоятельно записи через GUI Яндекса или через Terraform, Pulumi или Ansible. Красивые доменные имена каждому, и пусть никто не уйдет обиженным.</p><p>Мы все DNS-записи успешно «разместили» в одном облаке. Что дальше? У Yandex Cloud в каждой подсети на втором IP-адресе работает DNS-ресолвер. Если отправить ему запрос, мы получим имена и адреса всего, о чём знает VPC, из которой развёрнута подсеть. То есть нам осталось только подцепить и настроить форвардер над этим адресом: если запрос идёт на доменные зоны Яндекса, он отправляется на второй IP подсети, иначе — в наш корпоративный DNS.</p><p>Для отказоустойчивости размещаем такие форвардеры в каждом ЦОДе, ставим над ними балансер и его IP-адрес сообщаем всем заинтересованным. Заинтересованных двое: с одной стороны — наши трайбы в Yandex Cloud. Они в своих подсетях прописывают в настройках DHCP IP-адрес балансера. С другой стороны — это DNS самого банка. На нём прописываем зону yc.our и пробрасываем запросы в этот же IP:</p><figure class="full-width"><img data-blurred="true" data-src="https://habrastorage.org/getpro/habr/upload_files/c1d/32a/77e/c1d32a77e100c5106346e2d66bab2226.jpg" height="720" src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/c1d/32a/77e/c1d32a77e100c5106346e2d66bab2226.jpg" width="1280"/></figure><p>Форвардеры у нас работают внутри Kubernetes. Несколько реплик CoreDNS раскиданы по разным ЦОДам с помощью <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints">topologyContraints</a>, и опубликованы через hostPort, чтобы избежать лишнего хопа в сеть кубера. </p><p>Над ними поднят L4 балансировщик и, собственно, именно его IP, мы и отдаем командам. Балансировщик поднят отдельно от кубера, то есть мы не использовали Service типа LoadBalancer в самом Kubernetes на тот невероятный случай, если нам придется пересоздавать весь кластер. Балансер вне Kubernetes позволит нам сделать это бесшовно для наших пользователей.</p><p>Пример конфига выглядит так:</p><pre><code class="json"> {
    health {
        lameduck 10s
    }
    ready
    forward . 192.168.0.1 192.168.0.2 # внутренний DNS
    whoami
}
# Внутренние зоны Яндекса
mdb.yandexcloud.net {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}
auto.internal {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}
ru-central1.internal {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}
# Кастомные зоны команд
yc.our {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}
# Обратные зоны
101.10.in-addr.arpa {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}
102.10.in-addr.arpa {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}
103.10.in-addr.arpa {
    forward . 10.101.0.2 10.102.0.2 10.103.0.2
}</code></pre><p>Как видите, всё довольно просто: все зоны просто перенаправляются во второй IP всех подсетей, на которых развернуты ноды кубера.</p><p>Есть ещё несколько важных моментов. Во-первых, для оптимизации каждая реплика CoreDNS в идеале должна смотреть на второй IP именно той сети, в который она поднята. То есть если реплика поднята на ноде 10.102.0.131, то все её forward должны выглядеть так:</p><pre><code class="json">ru-central1.internal {
   # IP 10.102.0.2 идет первым 
   forward . 10.102.0.2 10.101.0.2 10.103.0.2
}</code></pre><p>Это логично, ведь если реплика развёрнута в 10.102, то зачем смотреть в сеть 10.101? Помимо производительности это ещё чревато тем, что если ЦОД, хостящий сеть 10.101, упадёт, то реплика в 10.102, прежде чем перейти к опросу в своей сети, будет некоторое время ждать ответа от первой упавшей, и клиент заметит деградацию производительности DNS.</p><p>Во-вторых, если деплоить CoreDNS в кубер, то надо обязательно поставить опцию <a href="https://coredns.io/plugins/health/">lameduck</a>. Я имею в виду вот этот кусочек в самом верху конфига:</p><pre><code class="json">health {
        lameduck 10s</code></pre><p>Эта настройка устанавливает время, которое CoreDNS будет выдерживать, прежде чем завершится после получения сигнала SIGTERM. Все readiness-пробы при этом будут падать, но пользовательские DNS-запросы всё ещё будут обрабатываться.</p><p>Зачем это нужно? Дело в том, что у вышестоящих балансеров всегда есть задержка, прежде чем они понимают, что приложение не работает и нужно выключить его из списка балансировки. У них есть таймаут и повторные попытки. Поэтому даже если выставить параметры проб максимально агрессивными, между ними всегда будут задержки. Всегда есть окно, когда приложение уже не работает, а балансеры об этом ещё не знают.</p><p>Настройка lameduck как раз позволяет это обойти для случаев штатного завершения контейнера. Это задержка, при которой CoreDNS ещё на самом деле работает, но отдаёт readiness-хелсчеки вида «я уже мёртв».</p><p>Эта настройка — важный ключ к обеспечению бесшовных rollout CoreDNS. Мы тестировали и так, и эдак — делали rollout Deployment, обновляли и убивали ноды Kubernetes… Продуктивный вариант сервиса пережил частичную неработоспособность кластера (та сама проблема с Garbage Collection, о которой мы рассказывали выше), а также последовательное обновление Kubernetes на 7 минорных версий вверх — и мы при этом не словили ни единого разрыва. В том числе благодаря этой настройке.</p><p>Значение lameduck подобрано исходя из параметров хелсчека балансеров по примерной формуле: (пауза между пробами + timeout) * (количество проб, прежде чем балансер пометит реплику как неживую) + 2–4 секунды запаса на всякий случай.</p><h2>Жизнь в облаке для финтеха — есть!</h2><p>Правда, она немножко колючая. Периодически возникают проблемы с сетевыми доступами. В первое время было много непоняток с тем, как организовано сопряжение нашей внутренней ролевой модели (AD) и Yandex Cloud и как правильно выдавать доступы своей команде.</p><p>Все, кто входят в облако, проходят отдельное обучение, входят в курс особенностей, о которых рассказал в статье.</p><p>Кроме того, несмотря на принятые меры, безопасники всё равно пускают в облако отнюдь не всех. У нас есть особая схема, которая позволяет примерно понять, можно ли приложению в облако или нет. Но даже после неё безопасники проводят свой дополнительный аудит и выдают окончательное решение. Некоторых заворачивают: «Нет, в Яндекс вам нельзя».</p><p>Но всё это точно перевешивают плюсы: классная техподдержка, PaaS, упрощённое использование IaC (ниже уровень вхождения, мы можем описать большую часть инфраструктуры). Всё это снимает очень много нагрузки с наших департаментов и упрощает жизнь командам.</p><h2>Заключение</h2><p>Развёртка нашего облака заняла от 9 до 15 месяцев, смотря как считать: первые четыре месяца выбирали между различными облаками и делали пилот. Cетевая связность, автоматизация выдачи ролей, допиливание Kubernetes и решение будущей организации всё вместе заняло еще полгода. Потом аккуратно, буквально на руках, заводили в облако первые трайбы, решая всплывающие недочёты. Так, например, глобальный DNS и улучшения node-init были сделаны именно на этих этапах.</p><p>Считаем, что справились: на постоянной основе в нашем закрытом облаке живут три трайба, ещё два частично, в режиме «одна нога здесь, другая там», и ещё некоторые активно смотрят и подыскивают себе бюджет, чтобы въехать в следующем году.</p><p></p></div></div></div> <!-- --> <!-- --></div> <!-- --> <!-- --></div> <!-- --> <div class="tm-article-presenter__meta"><div class="tm-article-presenter__meta-list tm-separated-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%87%D0%B0%D1%81%D1%82%D0%BD%D0%BE%D0%B5%20%D0%BE%D0%B1%D0%BB%D0%B0%D0%BA%D0%BE%5D">частное облако</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BE%D0%B1%D0%BB%D0%B0%D0%BA%D0%BE%5D">облако</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%8F%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%5D">яндекс</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Byandex%20cloud%5D">yandex cloud</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bad%5D">ad</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bcoredns%5D">coredns</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bterraform%5D">terraform</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bpulumi%5D">pulumi</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bansible%5D">ansible</a></li><li class="tm-separated-list__item"><a class="tm-tags-list__link" href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgarbage%20collection%5D">garbage collection</a></li> <!-- --></ul></div> <div class="tm-article-presenter__meta-list tm-separated-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a class="tm-hubs-list__link router-link-active" href="/ru/companies/otpbank/articles/">Блог компании ОТП Банк</a></li><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hubs/infosecurity/">Информационная безопасность</a></li><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hubs/cloud_services/">Облачные сервисы</a></li><li class="tm-separated-list__item"><a class="tm-hubs-list__link" href="/ru/hubs/kubernetes/">Kubernetes</a></li> <!-- --></ul></div></div> <!-- --></article></div> <!-- --></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-lever tm-article-rating__votes-switcher tm-votes-lever tm-votes-lever_appearance-article" title="Всего голосов 1: ↑1 и ↓0"><button class="tm-votes-lever__button" title="Нравится" type="button"><svg class="tm-svg-img tm-votes-lever__icon" height="24" width="24"><title>Голосование</title> <use xlink:href="/img/megazord-v28.faec9762..svg#counter-vote"></use></svg></button> <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-article"><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_positive">
          +1
        </span></span></div> <button class="tm-votes-lever__button" title="Не нравится" type="button"><svg class="tm-svg-img tm-votes-lever__icon tm-votes-lever__icon_arrow-down" height="24" width="24"><title>Голосование</title> <use xlink:href="/img/megazord-v28.faec9762..svg#counter-vote"></use></svg></button></div> <div class="v-portal" style="display:none;"></div> <!-- --></div> <!-- --> <!-- --> <button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button"><span class="tm-svg-icon__wrapper bookmarks-button__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v28.faec9762..svg#counter-favorite"></use></svg></span> <span class="bookmarks-button__counter" title="Количество пользователей, добавивших публикацию в закладки">
    4
  </span></button> <div class="tm-sharing tm-data-icons__item" title="Поделиться"><button class="tm-sharing__button" type="button"><svg class="tm-sharing__icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z" fill="currentColor"></path></svg></button> <div class="v-portal" style="display:none;"></div></div> <div class="tm-article-comments-counter-link tm-data-icons__item" title="Читать комментарии"><a class="tm-article-comments-counter-link__link" href="/ru/companies/otpbank/articles/793746/comments/"><svg class="tm-svg-img tm-article-comments-counter-link__icon" height="24" width="24"><title>Комментарии</title> <use xlink:href="/img/megazord-v28.faec9762..svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value">
      0
    </span></a> <!-- --></div> <!-- --> <div class="v-portal" style="display:none;"></div></div></div></div> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!-- --> <section class="tm-block tm-block tm-block_spacing-bottom"><!-- --> <div class="tm-block__body tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a class="tm-company-snippet__logo-link" href="/ru/companies/otpbank/profile/"><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" height="40" src="//habrastorage.org/getpro/habr/company/3cc/8e8/b55/3cc8e8b551d8126f04c5005009cad0ee.jpg" width="40"/></div></a> <div class="tm-company-snippet__info"><a class="tm-company-snippet__title" href="/ru/companies/otpbank/profile/">ОТП Банк</a> <div class="tm-company-snippet__description">Давай сделаем вместе!</div></div></div> <div class="tm-article-author__buttons"><!-- --> <!-- --></div></div> <div class="tm-article-author__company-contacts"><a class="tm-article-author__contact" href="https://www.otpbank.ru/" rel="noopener" target="_blank">
      Сайт
    </a></div> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a class="tm-user-card__userpic tm-user-card__userpic_size-40" href="/ru/users/risk_nic/"><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" src="https://assets.habr.com/habr-web/img/avatars/051.png"/></div></a> <div class="tm-user-card__meta"><div class="tm-counter-container tm-karma tm-karma" title=" 1 голос "><div class="tm-counter-container__header"><div class="tm-karma__votes tm-karma__votes_positive">
      1
    </div></div> <div class="tm-counter-container__footer"><div class="tm-karma__text">
      Карма
    </div> <div class="v-portal" style="display:none;"></div></div></div> <div class="tm-counter-container" title="Рейтинг пользователя"><div class="tm-counter-container__header"> <div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating"><!-- --> <div class="tm-votes-lever__score tm-votes-lever__score tm-votes-lever__score_appearance-rating"><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter tm-votes-lever__score-counter_rating">
          0
        </span></span></div> <!-- --></div></div> <div class="tm-counter-container__footer"><span class="tm-rating__text tm-rating__text">
      Рейтинг
    </span></div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title tm-user-card__title_variant-article"><!-- --> <a class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article" href="/ru/users/risk_nic/">
          @risk_nic
        </a> <!-- --></div> <p class="tm-user-card__short-info tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons tm-user-card__buttons_variant-article"><!-- --> <!-- --> <!-- --> <!-- --></div></div> <!-- --></div></div> <!-- --></section> <!-- --> <!-- --> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments" id="publication-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" href="/ru/companies/otpbank/articles/793746/comments/"><svg class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted" height="24" width="24"><title>Комментарии</title> <use xlink:href="/img/megazord-v28.faec9762..svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментировать 
    </span></a> <!-- --></div></div></div> <section class="tm-block tm-block tm-block_spacing-bottom"><header class="tm-block__header tm-block__header tm-block__header_variant-borderless"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2> </div> <!-- --></header> <div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim"><div class="tm-tabs tm-tabs"><div><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim">
        Лучшие за сутки
      </button></span><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link tm-tabs__tab-link_slim">
        Похожие
      </button></span></div> <!-- --></div> <div class="similar-and-daily__tab-view"><div class="placeholder-wrapper"><!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <div class="tm-placeholder-article-cards"><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div><div class="tm-placeholder-article-card"><div class="tm-placeholder__user"><div class="tm-placeholder__user-pic loads"></div> <div class="tm-placeholder__user-date loads"></div></div> <div class="tm-placeholder-article-card__title"><div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div> <div class="tm-placeholder__line tm-placeholder-article-card__title-line loads"></div></div> <div class="tm-placeholder-article-card__icons tm-placeholder__counters"><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div><div class="tm-placeholder-data-icon"><div class="tm-placeholder__icon tm-placeholder__icon_large loads"></div> <div class="tm-placeholder__line tm-placeholder__line_icon-text"></div></div></div></div></div> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --></div> <!-- --></div></div> <!-- --></section> <div class="placeholder-wrapper"><!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <div class="tm-placeholder-inset tm-placeholder-vacancies"><div class="tm-placeholder-inset__header"><div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div></div> <div class="tm-placeholder-inset__body"><ul class="tm-placeholder-list"><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div> <div class="tm-project-block-items__properties"><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div> <div class="tm-project-block-items__properties"><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div> <div class="tm-project-block-items__properties"><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div> <div class="tm-project-block-items__properties"><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder-list__title-container"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div></div> <div class="tm-project-block-items__properties"><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width: 100px;"></span></span></div></li></ul></div> <div class="tm-placeholder-inset__footer"><div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div></div></div> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --> <!-- --></div> <!-- --> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!-- --> <section class="tm-block tm-block tm-block_spacing-bottom"><header class="tm-block__header tm-block__header"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title">Информация</h2> </div> <!-- --></header> <div class="tm-block__body tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a class="tm-company-basic-info__link" href="https://www.otpbank.ru/" target="_blank">
      www.otpbank.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2021-09-07T07:44:16.000Z" title="2021-09-07, 10:44">7  сентября  2021</time></dd></dl> <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap"><span>
      1994
    </span></dd></dl> <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    5 001–10 000 человек
  </dd></dl> <dl class="tm-description-list tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <!-- --></div></div> <!-- --></section> <div class="tm-company-widgets"></div> <!-- --> <!-- --> <!-- --></div></div></div></div></div></div></main> <!-- --></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">
          Ваш аккаунт
        </p> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/companies/otpbank/articles/793746/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/companies/otpbank/articles/793746/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">
          Разделы
        </p> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/articles/">
                Статьи
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/news/">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/hubs/">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link router-link-active" href="/ru/companies/">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/users/">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/sandbox/">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">
          Информация
        </p> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/docs/help/">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/docs/authors/codex/">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/docs/companies/corpblogs/">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a class="footer-menu__item-link" href="/ru/docs/docs/transparency/">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">
          Услуги
        </p> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">
                Корпоративный блог
              </a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">
                Медийная реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">
                Нативные проекты
              </a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">
                Образовательные программы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">
                Стартапам
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!-- --> <div class="tm-footer__social"><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Facebook</title> <use xlink:href="/img/new-social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Twitter</title> <use xlink:href="/img/new-social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>VK</title> <use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Telegram</title> <use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Youtube</title> <use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Яндекс Дзен</title> <use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use></svg></a></div> <div class="v-portal" style="display:none;"></div> <button class="tm-footer__link"><!-- -->
        Настройка языка
      </button> <a class="tm-footer__link" href="/ru/feedback/">
        Техническая поддержка
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2024, </span> <span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank">Habr</a></span></span></div></div></div></div> <!-- --></div> <div class="vue-portal-target"></div></div>





<noscript>
<div>
<img alt="" src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;">
</img></div>
</noscript>


</body>
</html>
